<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Dashboard - UniPortal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fontawesome-local.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="dashboard-page">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <img src="/static/logo.png" alt="UniPortal Logo">
                <span>Lecturer Portal</span>
            </div>
            
            <!-- User Profile Section -->
            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; display: flex; align-items: center; gap: 12px;">
                <div style="flex: 1; min-width: 0;">
                    <div style="color: white; font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ current_user.username }}</div>
                    <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">{{ current_user.role }}</div>
                </div>
                <a href="{{ url_for('main.profile') }}" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; color: white; text-decoration: none; flex-shrink: 0;">
                    {{ current_user.avatar_initials }}
                </a>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <a href="{{ url_for('main.dashboard') }}" class="nav-item">
                <span class="icon"><i class="fas fa-home"></i></span>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('main.attendance_dashboard') }}" class="nav-item active">
                <span class="icon"><i class="fas fa-clipboard-check"></i></span>
                <span>Attendance</span>
            </a>
            <a href="{{ url_for('main.library') }}" class="nav-item">
                <span class="icon"><i class="fas fa-book-open"></i></span>
                <span>Library</span>
            </a>
            <a href="{{ url_for('main.settings') }}" class="nav-item">
                <span class="icon"><i class="fas fa-cog"></i></span>
                <span>Settings</span>
            </a>
            <a href="{{ url_for('main.logout') }}" class="nav-item" onclick="return confirmLogout(event);">
                <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
                <span>Logout</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-msg {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Header -->
        <div class="page-header" style="margin-bottom: 30px;">
            <h1 class="page-title"><i class="fas fa-clipboard-check"></i> Attendance Dashboard</h1>
            <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px; margin-top: 10px;">
                View and manage attendance records for your courses
            </p>
        </div>

        <!-- Statistics Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: rgba(16, 185, 129, 0.2); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; border: 1px solid rgba(16, 185, 129, 0.3);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(16, 185, 129, 0.3); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-chalkboard-teacher" style="font-size: 24px; color: #10b981;"></i>
                    </div>
                    <div>
                        <div style="color: white; font-size: 28px; font-weight: bold;">{{ lecturer_courses|length }}</div>
                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">My Courses</div>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(59, 130, 246, 0.2); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; border: 1px solid rgba(59, 130, 246, 0.3);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(59, 130, 246, 0.3); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-calendar-check" style="font-size: 24px; color: #3b82f6;"></i>
                    </div>
                    <div>
                        <div style="color: white; font-size: 28px; font-weight: bold;">{{ attendance_data|length }}</div>
                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">Total Sessions</div>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(139, 92, 246, 0.2); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; border: 1px solid rgba(139, 92, 246, 0.3);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(139, 92, 246, 0.3); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-check" style="font-size: 24px; color: #8b5cf6;"></i>
                    </div>
                    <div>
                        <div style="color: white; font-size: 28px; font-weight: bold;">
                            {% set total_present = namespace(count=0) %}
                            {% for data in attendance_data %}
                                {% set total_present.count = total_present.count + data.count %}
                            {% endfor %}
                            {{ total_present.count }}
                        </div>
                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">Total Present</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Start Attendance Session -->
        <div class="table-card" style="margin-bottom: 30px;">
            <h2>üìç Start Attendance Session</h2>
            <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px; margin-bottom: 20px;">
                Start an attendance session using your current location. Students within 50 meters can mark attendance.
            </p>
            
            <form id="attendanceForm" method="POST" action="{{ url_for('main.start_attendance') }}">
                <input type="hidden" name="latitude" id="repLatitude">
                <input type="hidden" name="longitude" id="repLongitude">
                
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
                    <div>
                        <label style="color: white; display: block; margin-bottom: 8px; font-size: 14px;">
                            <i class="fas fa-book"></i> Select Course *
                        </label>
                        {% if lecturer_courses %}
                        <select name="course_id" id="attendanceCourse" required style="width: 100%; padding: 12px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 10px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                            <option value="">-- Choose a Course --</option>
                            {% for course in lecturer_courses %}
                            <option value="{{ course.id }}">{{ course.name }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <div style="padding: 12px; background: rgba(255, 165, 0, 0.2); border: 1px solid rgba(255, 165, 0, 0.4); border-radius: 10px; color: white; font-size: 13px;">
                            <i class="fas fa-info-circle"></i> No courses assigned to you yet.
                        </div>
                        {% endif %}
                    </div>
                    <button type="button" onclick="startAttendanceSession()" class="btn-download-all" style="padding: 12px 30px; white-space: nowrap;">
                        <i class="fas fa-map-marker-alt"></i> Start Session
                    </button>
                </div>
                
                <div id="locationStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;"></div>
            </form>
            
            <!-- Export Attendance -->
            {% if lecturer_courses %}
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="color: white; margin-bottom: 15px; font-size: 16px;">üìä Export Attendance Records</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    {% for course in lecturer_courses %}
                    <a href="{{ url_for('main.export_attendance', course_id=course.id) }}" 
                       style="padding: 10px 20px; background: rgba(34, 197, 94, 0.8); color: white; text-decoration: none; border-radius: 8px; font-size: 13px; transition: background 0.3s;"
                       onmouseover="this.style.background='rgba(34, 197, 94, 1)'"
                       onmouseout="this.style.background='rgba(34, 197, 94, 0.8)'">
                        <i class="fas fa-download"></i> {{ course.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Attendance Records by Course -->
        {% if attendance_data %}
        {% for data in attendance_data %}
        <div class="table-card" style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2><i class="fas fa-book"></i> {{ data.course.name }}</h2>
                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin-top: 5px;">
                        Session: {{ data.session.timestamp.strftime('%B %d, %Y at %H:%M') }}
                        {% if data.session.is_active %}
                        <span style="display: inline-block; padding: 3px 8px; background: rgba(16, 185, 129, 0.3); color: #10b981; border-radius: 12px; font-size: 11px; margin-left: 10px;">
                            <i class="fas fa-circle" style="font-size: 8px;"></i> Active
                        </span>
                        {% else %}
                        <span style="display: inline-block; padding: 3px 8px; background: rgba(107, 114, 128, 0.3); color: #9ca3af; border-radius: 12px; font-size: 11px; margin-left: 10px;">
                            Closed
                        </span>
                        {% endif %}
                    </p>
                </div>
                <div style="color: white; font-size: 18px; font-weight: 600;">
                    <i class="fas fa-users"></i> {{ data.count }} Present
                </div>
            </div>
            
            {% if data.records %}
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Student Name</th>
                            <th>Index Number</th>
                            <th>Time Marked</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in data.records %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: white;">
                                        {{ record.student.avatar_initials }}
                                    </div>
                                    <div>
                                        <div style="color: white; font-weight: 500;">{{ record.student_name or record.student.username }}</div>
                                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">{{ record.student.email }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span style="font-family: 'Courier New', monospace; color: #60a5fa; font-weight: 600;">
                                    {{ record.index_number or 'N/A' }}
                                </span>
                            </td>
                            <td>{{ record.timestamp.strftime('%H:%M:%S') }}</td>
                            <td>
                                <span style="display: inline-block; padding: 4px 12px; background: rgba(16, 185, 129, 0.3); color: #10b981; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> {{ record.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                <i class="fas fa-user-slash" style="font-size: 48px; margin-bottom: 15px; color: rgba(255, 255, 255, 0.3);"></i>
                <p>No students marked attendance for this session yet.</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <div class="table-card">
            <div style="text-align: center; padding: 60px 20px; color: rgba(255, 255, 255, 0.6);">
                <i class="fas fa-clipboard-list" style="font-size: 64px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.3);"></i>
                <h3 style="color: white; margin-bottom: 10px;">No Attendance Sessions Yet</h3>
                <p>Start an attendance session from your dashboard to track student attendance.</p>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/geolocation-fix.js') }}"></script>
    <script>
        function confirmLogout(event) {
            return confirm('Are you sure you want to logout?');
        }

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Geolocation Attendance System
        function startAttendanceSession() {
            const courseSelect = document.getElementById('attendanceCourse');
            const locationStatus = document.getElementById('locationStatus');
            
            if (!courseSelect || !courseSelect.value) {
                alert('Please select a course first!');
                return;
            }
            
            locationStatus.style.display = 'block';
            
            // Use enhanced geolocation system
            startAttendanceWithLocation('attendanceForm', 'locationStatus');
        }
    </script>
</body>
</html>
