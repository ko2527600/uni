{% from 'components.html' import autocomplete %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library - UniPortal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fontawesome-local.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="dashboard-page">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <img src="/static/logo.png" alt="UniPortal Logo">
                <span>UniPortal</span>
            </div>
            
            <!-- User Profile Section -->
            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; display: flex; align-items: center; gap: 12px;">
                <div style="flex: 1; min-width: 0;">
                    <div style="color: white; font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ current_user.username }}</div>
                    <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">{{ current_user.role }}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    {% if current_user.class_group and current_user.class_group.is_active_premium %}
                    <span style="display: inline-block; padding: 4px 8px; background: rgba(156, 163, 175, 0.8); color: white; border-radius: 6px; font-size: 11px; font-weight: 600;">PRO</span>
                    {% else %}
                    <a href="{{ url_for('main.subscription') }}" style="display: inline-block; padding: 4px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px; font-size: 11px; font-weight: 600; text-decoration: none; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-arrow-up"></i> Upgrade
                    </a>
                    {% endif %}
                    <a href="{{ url_for('main.profile') }}" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; color: white; text-decoration: none; flex-shrink: 0;">
                        {{ current_user.avatar_initials }}
                    </a>
                </div>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <a href="{{ url_for('main.dashboard') }}" class="nav-item">
                <span class="icon"><i class="fas fa-home"></i></span>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('main.library') }}" class="nav-item active">
                <span class="icon"><i class="fas fa-book"></i></span>
                <span>Library</span>
            </a>
            <a href="{{ url_for('main.subscription') }}" class="nav-item">
                <span class="icon"><i class="fas fa-gem"></i></span>
                <span>Subscription</span>
            </a>
            <a href="{{ url_for('main.settings') }}" class="nav-item">
                <span class="icon"><i class="fas fa-cog"></i></span>
                <span>Settings</span>
            </a>
            <a href="{{ url_for('main.logout') }}" class="nav-item" onclick="return confirmLogout(event);">
                <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
                <span>Logout</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-msg {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Header with Search -->
        <div class="page-header" style="margin-bottom: 30px;">
            <h1 class="page-title"><i class="fas fa-book-open"></i> UniPortal Library</h1>
            <div style="margin-top: 20px;">
                {{ autocomplete('q', 'Search for books, authors, topics...', suggestions, search_query or '') }}
            </div>
        </div>

        <!-- Class Resources Section -->
        <div class="table-card" style="margin-bottom: 30px;">
            <h2><i class="fas fa-school"></i> Class Resources</h2>
            {% if local_resources %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                {% for resource in local_resources %}
                <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.2); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                    <!-- Cover Image or Icon -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        {% if resource.cover_image %}
                        <img src="{{ resource.cover_image }}" alt="{{ resource.title }}" style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px;">
                        {% else %}
                        <div style="width: 100%; height: 180px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-file-pdf" style="font-size: 64px; color: white;"></i>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Title -->
                    <h3 style="color: white; font-size: 16px; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ resource.title }}">{{ resource.title }}</h3>
                    
                    <!-- Author -->
                    {% if resource.author %}
                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin-bottom: 8px;">
                        <i class="fas fa-user"></i> {{ resource.author }}
                    </p>
                    {% endif %}
                    
                    <!-- Category -->
                    {% if resource.category %}
                    <span style="display: inline-block; padding: 4px 10px; background: rgba(59, 130, 246, 0.3); color: #60a5fa; border-radius: 12px; font-size: 11px; margin-bottom: 12px;">
                        {{ resource.category }}
                    </span>
                    {% endif %}
                    
                    <!-- Uploader -->
                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-bottom: 15px;">
                        Uploaded by {{ resource.uploader.username }}
                    </p>
                    
                    <!-- Action Button -->
                    {% if resource.external_link %}
                    <a href="{{ resource.external_link }}" target="_blank" style="display: block; width: 100%; padding: 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-align: center; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-external-link-alt"></i> Open Link
                    </a>
                    {% else %}
                    <a href="{{ url_for('main.download_resource', resource_id=resource.id) }}" style="display: block; width: 100%; padding: 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; text-align: center; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-download"></i> Download
                    </a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 60px 20px; color: rgba(255, 255, 255, 0.6);">
                <i class="fas fa-book-open" style="font-size: 64px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.3);"></i>
                <h3 style="color: white; margin-bottom: 10px;">No Class Resources Yet</h3>
                <p>Resources uploaded by your class will appear here.</p>
            </div>
            {% endif %}
        </div>

        <!-- Global Search Results Section (Google Books) -->
        <div class="table-card">
            <h2><i class="fas fa-globe"></i> Discover Books</h2>
            {% if search_query %}
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 20px;">
                Showing results for "<strong>{{ search_query }}</strong>" from Google Books
            </p>
            {% else %}
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 20px;">
                Explore popular science books from Google Books
            </p>
            {% endif %}
            
            {% if api_books %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                {% for book in api_books %}
                <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.2); transition: transform 0.3s, box-shadow 0.3s; position: relative;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                    <!-- Rating Badge -->
                    {% if book.rating %}
                    <div style="position: absolute; top: 10px; right: 10px; background: rgba(251, 191, 36, 0.9); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                        <i class="fas fa-star"></i> {{ "%.1f"|format(book.rating) }}
                    </div>
                    {% endif %}
                    
                    <!-- Cover Image (2:3 Aspect Ratio) -->
                    <div style="text-align: center; margin-bottom: 15px; position: relative; padding-bottom: 150%; overflow: hidden; border-radius: 8px;">
                        {% if book.thumbnail %}
                        <img src="{{ book.thumbnail }}" alt="{{ book.title }}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-book" style="font-size: 64px; color: white;"></i>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Title -->
                    <h3 style="color: white; font-size: 16px; margin-bottom: 8px; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical;" title="{{ book.title }}">{{ book.title }}</h3>
                    
                    <!-- Author -->
                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        <i class="fas fa-user"></i> {{ book.authors }}
                    </p>
                    
                    <!-- Publisher & Year -->
                    {% if book.publisher or book.publishedDate %}
                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-bottom: 12px;">
                        {% if book.publisher %}
                        <i class="fas fa-building"></i> {{ book.publisher }}
                        {% endif %}
                        {% if book.publishedDate %}
                        <span style="margin-left: 8px;"><i class="fas fa-calendar"></i> {{ book.publishedDate[:4] }}</span>
                        {% endif %}
                    </p>
                    {% endif %}
                    
                    <!-- Description Preview -->
                    {% if book.description %}
                    <p style="color: rgba(255, 255, 255, 0.5); font-size: 11px; margin-bottom: 15px; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical;">
                        {{ book.description }}
                    </p>
                    {% endif %}
                    
                    <!-- Action Button -->
                    <a href="{{ book.link }}" target="_blank" style="display: block; width: 100%; padding: 10px; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; text-align: center; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-book-reader"></i> Preview on Google Books
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 60px 20px; color: rgba(255, 255, 255, 0.6);">
                <i class="fas fa-search" style="font-size: 64px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.3);"></i>
                <h3 style="color: white; margin-bottom: 10px;">No Results Found</h3>
                <p>Try searching with different keywords.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function confirmLogout(event) {
            return confirm('Are you sure you want to logout?');
        }

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }
    </script>
</body>
</html>
